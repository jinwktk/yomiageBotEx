# yomiageBotEx システム再設計提案

## 現在の問題分析

### 重大な問題
1. **音声接続不安定性**: WebSocket 4006エラー頻発
2. **全コマンドタイムアウト**: Discord API 3秒制限を超過
3. **複雑な処理フロー**: 音声・TTS・録音の相互依存
4. **パフォーマンス劣化**: システム全体の応答性低下

### 根本原因
- py-cordの音声処理がDiscordサーバーとの接続を不安定化
- 複数の重い処理（録音・TTS・音声再生）が同時実行
- イベントループのブロッキング処理

## 新しいアーキテクチャ設計

### 1. **モジュラー設計**
```
yomiageBotEx-v2/
├── core/                   # コアシステム
│   ├── bot.py             # 軽量なDiscordボット本体
│   ├── command_handler.py # 高速コマンド処理
│   └── event_manager.py   # イベント管理
├── services/              # 独立サービス
│   ├── tts_service.py     # TTS専用サービス
│   ├── voice_service.py   # 音声接続専用サービス
│   ├── recording_service.py # 録音専用サービス
│   └── message_service.py # メッセージ読み上げサービス
├── utils/                 # ユーティリティ
│   ├── config.py          # 統一設定管理
│   ├── logger.py          # ログシステム
│   └── database.py        # データベース管理
└── api/                   # REST API（オプション）
    └── web_interface.py   # Web管理画面
```

### 2. **パフォーマンス重視設計**
- **非ブロッキング処理**: 全ての重い処理を別スレッド/プロセス
- **軽量コマンド**: コマンド実行は1秒以内に完了
- **独立サービス**: 各機能が独立して動作
- **設定の動的変更**: 再起動なしの設定変更

### 3. **安定性向上**
- **エラー分離**: 1つの機能が停止しても他に影響しない
- **自動復旧**: サービス単位での自動再接続
- **ヘルスチェック**: 各サービスの健康状態監視
- **フォールバック**: 機能停止時の代替処理

### 4. **機能分離**
```python
# 例：軽量コマンド処理
@bot.slash_command()
async def reading(ctx):
    # 即座に応答（1秒以内）
    await ctx.respond("設定を変更中...", ephemeral=True)
    
    # バックグラウンドで実際の処理
    asyncio.create_task(message_service.toggle_reading(ctx.guild.id))
```

## 実装計画

### Phase 1: コア安定化（1週間）
- [x] 音声自動接続無効化（緊急対処完了）
- [ ] 軽量コマンドシステム構築
- [ ] 基本的なTTS機能のみ実装

### Phase 2: サービス分離（2週間）
- [ ] TTS専用サービス作成
- [ ] 音声接続サービス独立
- [ ] 録音サービス独立

### Phase 3: 機能復旧（1週間）
- [ ] 安定した音声接続実装
- [ ] 高性能録音システム
- [ ] 統合テスト

## 技術スタック変更提案

### 現在 → 新規
- **Discord.py**: py-cord → discord.py 2.3.0（より安定）
- **音声処理**: WaveSink → 専用音声プロセス
- **設定管理**: YAML → SQLite + JSON
- **ログ管理**: ファイル → 構造化ログ + 監視

## 期待される改善

### パフォーマンス
- コマンド応答時間: 3秒+ → 0.5秒以内
- メモリ使用量: 200MB → 100MB以下
- CPU使用率: 不安定 → 常時5%以下

### 安定性
- 音声接続エラー: 頻発 → 自動復旧
- コマンド成功率: 50% → 99%+
- システム稼働時間: 不安定 → 24時間連続

### 保守性
- デバッグ時間: 長時間 → 5分以内特定
- 新機能追加: 困難 → 独立して追加可能
- 設定変更: 再起動必要 → リアルタイム変更

## 結論
現在のシステムは複雑化しすぎており、根本的な再設計が必要です。
新しいモジュラー設計により、各機能が独立して安定動作する
高性能なDiscord読み上げボットを構築できます。